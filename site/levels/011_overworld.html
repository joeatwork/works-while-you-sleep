<html>
<head>
  <meta charset="UTF-8">
  <title>011 "Overworld" : Works While You Sleep!</title>
  <link rel="stylesheet" href="../styles/robot_series.css">
  <style>
    .screen_area {
        display: inline-block;
	border-top: 2px solid black;
	border-bottom: 2px solid black;
	border-left: 2px solid black;
    }

    .screen_area:last-child {
	border-right: 2px solid black;
    }
  </style>
<!-- start Mixpanel --><script type="text/javascript">(function(d,c){var a,b,g,e;a=d.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===d.location.protocol?"https:":"http:")+'//api.mixpanel.com/site_media/js/api/mixpanel.2.js';b=d.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b);c._i=[];c.init=function(a,d,f){var b=c;"undefined"!==typeof f?b=c[f]=[]:f="mixpanel";g="disable track track_pageview track_links track_forms register register_once unregister identify name_tag set_config".split(" ");
for(e=0;e<g.length;e++)(function(a){b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,0)))}})(g[e]);c._i.push([a,d,f])};window.mixpanel=c})(document,[]);
mixpanel.init("8225af3b4eb4e53902e4cd79c242cc60");</script><!-- end Mixpanel -->
<script>
// Mixpanel stuff
mixpanel.track('pageview', { page: 'overworld_001' });
</script>
</head>
<body>
<header>
  <hgroup>
    <div id="datebox"
         style="float: right; width: 160px;"
         ><time>2012-01-30</time:></div>
    <h1>Works While You Sleep!</h1>
  </hgroup>  
</header>
<section>
  <div class="screen_area screen_01_area"
       style="background-color: white;"
       ><canvas width="320" height="320" id="screen_01"
                ></div><!--

 --><div class="screen_area screen_02_area"
       style="background-color: white;"
       ><canvas width="320" height="320" id="screen_02"
                ></div><!--

  --><div class="screen_area screen_02_area"
       style="background-color: white;"
       ><canvas width="320" height="320" id="screen_03"
                ></div><!-- .body-area -->
</section>

<section>
  <div class="about-area">
    <div class="about-box">
      Inspired by <a href="http://playdamage.org">playdamage.org</a>.
      Built by Joe Bowers, who maintains a web site at
      <a href="http://www.joe-bowers.com">joe-bowers.com</a>
    </div><!-- .about-box -->
    <div style="display:none"
         >Running at <span id="show_fps">?</span> frames per second</div>
  </div><!-- .about-area -->
</section>

<!-- NO MORE CONTENT -->
<script src="../lib/jquery-1.7.2.min.js"></script>
<script src="../lib/underscore-1.4.3.min.js"></script>
<script src="../js/v2.0/chorus.js"></script>
<script src="../js/v2.0/bounds.js"></script>
<script src="../js/v2.0/game.js"></script>
<script>
$(document).ready(function() {
    "use strict";

    window.requestAnimFrame = (function(callback){
        return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function(callback){
                window.setTimeout(callback, 10);
            };
    })();//polyfill

    var orientationToFrames = {};
    orientationToFrames[window.level.PlayerCharacter.WALK_NORTH] = 'WALK_NORTH';
    orientationToFrames[window.level.PlayerCharacter.WALK_SOUTH] = 'WALK_SOUTH';
    orientationToFrames[window.level.PlayerCharacter.WALK_EAST] = 'WALK_EAST';
    orientationToFrames[window.level.PlayerCharacter.WALK_WEST] = 'WALK_WEST';
    orientationToFrames[window.level.PlayerCharacter.REST] = 'SOUTH';

    var heroFrames01 = {
	NORTH: [ { top: 0, left: 32 * 1, width: 32, height: 32 } ],
	WALK_NORTH: [ { top: 0, left: 32 * 5, width: 32, height: 32 },
		      { top: 0, left: 32 * 6, width: 32, height: 32 } ],
	SOUTH: [ { top: 0, left: 0, width: 32, height: 32 } ],
	WALK_SOUTH: [ { top: 0, left: 32 * 3, width: 32, height: 32 },
		      { top: 0, left: 32 * 4, width: 32, height: 32 } ],
	WEST: [ { top: 0, left: 32 * 2, width: 32, height: 32 } ],
	WALK_WEST: [ { top: 0, left: 32 * 8, width: 32, height: 32 },
		     { top: 0, left: 32 * 7, width: 32, height: 32 } ],
	EAST: [ { top: 0, left: 32 * 10, width: 32, height: 32 } ],
	WALK_EAST: [ { top: 0, left: 32 * 9, width: 32, height: 32 },
		     { top: 0, left: 32 * 10, width: 32, height: 32 } ]
    };

    var heroFrames02 = {
	NORTH: [ { top: 32, left: 32 * 1, width: 32, height: 32 } ],
	WALK_NORTH: [ { top: 32, left: 32 * 5, width: 32, height: 32 },
		      { top: 32, left: 32 * 6, width: 32, height: 32 } ],
	SOUTH: [ { top: 32, left: 0, width: 32, height: 32 } ],
	WALK_SOUTH: [ { top: 32, left: 32 * 3, width: 32, height: 32 },
		      { top: 32, left: 32 * 4, width: 32, height: 32 } ],
	WEST: [ { top: 32, left: 32 * 2, width: 32, height: 32 } ],
	WALK_WEST: [ { top: 32, left: 32 * 8, width: 32, height: 32 },
		     { top: 32, left: 32 * 7, width: 32, height: 32 } ],
	EAST: [ { top: 32, left: 32 * 10, width: 32, height: 32 } ],
	WALK_EAST: [ { top: 32, left: 32 * 9, width: 32, height: 32 },
		     { top: 32, left: 32 * 10, width: 32, height: 32 } ]
    };

    var heroFrames03 = {
	NORTH: [ { top: 64, left: 32 * 1, width: 32, height: 32 } ],
	WALK_NORTH: [ { top: 64, left: 32 * 5, width: 32, height: 32 },
		      { top: 64, left: 32 * 6, width: 32, height: 32 } ],
	SOUTH: [ { top: 64, left: 0, width: 32, height: 32 } ],
	WALK_SOUTH: [ { top: 64, left: 32 * 3, width: 32, height: 32 },
		      { top: 64, left: 32 * 4, width: 32, height: 32 } ],
	WEST: [ { top: 64, left: 32 * 2, width: 32, height: 32 } ],
	WALK_WEST: [ { top: 64, left: 32 * 8, width: 32, height: 32 },
		     { top: 64, left: 32 * 7, width: 32, height: 32 } ],
	EAST: [ { top: 64, left: 32 * 10, width: 32, height: 32 } ],
	WALK_EAST: [ { top: 64, left: 32 * 9, width: 32, height: 32 },
		     { top: 64, left: 32 * 10, width: 32, height: 32 } ]
    };

    var WALK_ANIMATION_SPEED = 8; // PIXELS PER FRAME ANIMATION

    // (logical) center of hero
    var heroStart01 = { x: 320 + 16, y: 800 + 16, dx: 0, dy: 1 };
    var heroStart02 = { x: 928 + 16, y: 800 + 16, dx: 0, dy: 1 };
    var heroStart03 = { x: 800 + 16, y: 384 + 16, dx: 0, dy: 1 };

    var screen01 = $('#screen_01')[0];
    var screen02 = $('#screen_02')[0];
    var screen03 = $('#screen_03')[0];
    var show_fps = $('#show_fps');

    // Draws hero frame to BACKING, FULL-SIZED RENDER GFX
    var drawHero = function(gfx, heroPosition, heroFrame) {
	var heroWidth = heroFrame.width;
	var heroHeight = heroFrame.height;
	var heroOffsetX = heroPosition.x - (heroWidth / 2);
	var heroOffsetY = heroPosition.y - (heroHeight / 2);

	heroOffsetY = heroOffsetY - 8; // aesthetic tweak.
	gfx.drawImage(heroes,
		      heroFrame.left, heroFrame.top,
		      heroWidth, heroHeight,
		      heroOffsetX, heroOffsetY,
		      heroWidth, heroHeight);
    }

    var drawScreen = function(backCanvas, screenCanvas, heroPosition) {
	var bgOffsetX = heroPosition.x - (screenCanvas.width / 2);
	var bgOffsetY = heroPosition.y - (screenCanvas.height / 2);

	var screenGfx = screenCanvas.getContext("2d");
	screenGfx.drawImage(backCanvas, -bgOffsetX, -bgOffsetY);
    }

    var ANIMATION_WIDTH_PX = 32; // in PIXELS, not TIME
    var pickFrame = function(hero, heroFrames) {
	var frameListName = orientationToFrames[ hero.orientation() ];
	var offsetPx = 0;
	if ((frameListName == 'WALK_EAST') ||
	    (frameListName == 'WALK_WEST')) {
	    offsetPx = hero.x % ANIMATION_WIDTH_PX;
	}
	else {
	    offsetPx = hero.y % ANIMATION_WIDTH_PX;
	}

	var frameList = heroFrames[ frameListName ];
	var offsetFrame = Math.floor((offsetPx / ANIMATION_WIDTH_PX) * frameList.length);
	return frameList[offsetFrame];
    }

    ////////////////////////////////////
    // Load and run.

    var loadManager = new Chorus();
    var background = new Image();
    background.onload = loadManager.addCallback();
    background.src = "011_overworld/world_map_background.png";
    
    var heroes = new Image();
    heroes.onload = loadManager.addCallback();
    heroes.src = "sprites/spaceman_overworld_16x16.png";

    var bounds = null;
    var boundsReady = loadManager.addCallback();
    var boundsImage = new Image();
    boundsImage.onload = function() {
	bounds = Bounds.create(boundsImage);
	bounds.onReady = boundsReady;
    };
    boundsImage.src = "011_overworld/world_map_bounds.png";

    loadManager.setOnComplete(function() {
	var hero01 = new window.level.PlayerCharacter(heroStart01.x,
						      heroStart01.y,
						      heroStart01.dx,
						      heroStart01.dy,
						      32, 32, bounds);

	var hero02 = new window.level.PlayerCharacter(heroStart02.x,
						      heroStart02.y,
						      heroStart02.dx,
						      heroStart02.dy,
						      32, 32, bounds);

	var hero03 = new window.level.PlayerCharacter(heroStart03.x,
						      heroStart03.y,
						      heroStart03.dx,
						      heroStart03.dy,
						      32, 32, bounds);

	var renderCanvas = document.createElement('canvas');
	renderCanvas.width = background.width;
	renderCanvas.height = background.height;

	var fps_update = Date.now();
	var frames = 0;
	var animate = function() {
	    var now = Date.now();
	    frames++;

	    if (now - fps_update > 1000) {
		show_fps.text(frames * 1000 / (now - fps_update));
		frames = 0;
		fps_update = now;
	    }

	    hero01.update(now);
	    hero02.update(now);
	    hero03.update(now);

	    var renderGfx = renderCanvas.getContext("2d");
	    renderGfx.drawImage(background, 0, 0);

	    var hero01Frame = pickFrame(hero01, heroFrames01);
	    drawHero(renderGfx, hero01, hero01Frame);

	    var hero02Frame = pickFrame(hero02, heroFrames02);
	    drawHero(renderGfx, hero02, hero02Frame);

	    var hero03Frame = pickFrame(hero03, heroFrames03);
	    drawHero(renderGfx, hero03, hero03Frame);

	    drawScreen(renderCanvas, screen01, hero01);
	    drawScreen(renderCanvas, screen02, hero02);
	    drawScreen(renderCanvas, screen03, hero03);

	    requestAnimFrame(animate);
	};
	requestAnimFrame(animate);
    });

    loadManager.arm();

});
</script>
</body>
</html>
